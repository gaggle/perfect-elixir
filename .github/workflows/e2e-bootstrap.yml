# GitHub Actions Workflow: e2e-bootstrap

name: e2e-bootstrap

on:
  push:
    branches: [ "**" ] # triggers on branch commits only
    paths:
      - .github/workflows/e2e-bootstrap.yml
      - bin/bootstrap
      - test_helpers/e2e
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-e2e-bootstrap

env:
  BOOTSTRAP_URL: https://raw.githubusercontent.com/gaggle/perfect-elixir/refs/heads/perfect-elixir-5-onboarding/bin/bootstrap
  GH_TOKEN: ${{ github.token }}
  NONINTERACTIVE: true

jobs:
  e2e-bootstrap:
    strategy:
      fail-fast: false
      matrix:
        shell_invoker:
          - { name: "Native Bash", cmd: "bash --noprofile --norc -c" }
          - { name: "Latest Bash", cmd: "pkgx bash@5.2.37 --noprofile --norc -c" }
          - { name: "Native Zsh", cmd: "zsh -l -c" }
        os:
          - macos-14
          - macos-15
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.shell_invoker.name }} (${{ matrix.os }})
    steps:
      - name: Checkout Repository to Subfolder
        uses: actions/checkout@v3
        with:
          path: repo

      - uses: pkgxdev/setup@v1

      - name: Run Bootstrap Steps
        run: |
          ${{ matrix.shell_invoker.cmd }} '
          source $(pwd)/repo/test_helpers/e2e
          
          curl -fsSL $BOOTSTRAP_URL > /tmp/bootstrap && source_bootstrap
          assert_output "User action required: Activate pkgx shell integration"
          do_step "Integrating pkgx" "eval \"\$(pkgx integrate)\""
          
          source_bootstrap
          assert_output "User action required: Clone the repository"
          do_step "Cloning the repo" \
            "pkgx gh repo clone gaggle/perfect-elixir" \
            "cd perfect-elixir" \
            "git checkout perfect-elixir-5-onboarding"

          source_bootstrap
          assert_output "User action required: Activate developer environment"
          do_step "Running dev" "dev"

          source_bootstrap
          assert_output "Onboarding complete!" || exit 1
          '
